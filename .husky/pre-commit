#!/bin/sh

# Enable debug mode with: DEBUG=1 git commit -m "message"
# Or uncomment the next line for always-on debugging:
# DEBUG=1

if [ "$DEBUG" = "1" ]; then
  set -x  # Print each command before executing
fi

# Exit immediately if a command fails (helps identify which step failed)
set -e

# Sensitive data check
echo "Checking for sensitive data in staged files..."

EMAIL=$(git config user.email)
USERNAME=$(git config user.name)
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM)

if [ -z "$STAGED_FILES" ]; then
  echo "No staged files to check."
else
  # Check for email address
  if [ -n "$EMAIL" ]; then
    FOUND=$(echo "$STAGED_FILES" | xargs grep -l "$EMAIL" 2>/dev/null || true)
    if [ -n "$FOUND" ]; then
      echo "ERROR: Your email address ($EMAIL) found in:"
      echo "$FOUND"
      exit 1
    fi
  fi

  # Check for username
  if [ -n "$USERNAME" ]; then
    FOUND=$(echo "$STAGED_FILES" | xargs grep -l "$USERNAME" 2>/dev/null || true)
    if [ -n "$FOUND" ]; then
      echo "ERROR: Your username ($USERNAME) found in:"
      echo "$FOUND"
      exit 1
    fi
  fi

  # Check for API keys and secrets patterns
  SECRETS_PATTERN="(api[_-]?key|apikey|secret[_-]?key|access[_-]?token|auth[_-]?token|private[_-]?key|password)\s*[:=]\s*['\"][^'\"]{8,}['\"]"
  FOUND=$(echo "$STAGED_FILES" | xargs grep -liE "$SECRETS_PATTERN" 2>/dev/null || true)
  if [ -n "$FOUND" ]; then
    echo "ERROR: Potential API keys/secrets/passwords found in:"
    echo "$FOUND"
    echo "Please review these files and remove sensitive data."
    exit 1
  fi

  # Check for common secret file patterns
  FOUND=$(echo "$STAGED_FILES" | grep -E "\.(env|pem|key|p12|pfx|credentials)$" 2>/dev/null || true)
  if [ -n "$FOUND" ]; then
    echo "ERROR: Potentially sensitive files staged:"
    echo "$FOUND"
    exit 1
  fi

  echo "No sensitive data detected."
fi
